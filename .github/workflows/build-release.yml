name: Build Release Binaries

# Triggers: when a GitHub Release is published, or manually via workflow_dispatch
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload artifacts to latest release?'
        required: false
        default: 'false'

jobs:
  # ── Windows Build ────────────────────────────────────────────────────────────
  build-windows:
    name: Windows .exe (PyInstaller)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies + PyInstaller
        working-directory: server
        shell: pwsh
        run: |
          python -m venv .venv
          .\.venv\Scripts\Activate.ps1
          pip install -r requirements.txt --quiet
          pip install pyinstaller --quiet

      - name: Get version from config
        id: version
        shell: pwsh
        run: |
          $line = Select-String -Path "server\config.py" -Pattern 'APP_VERSION\s*=\s*"([^"]+)"' | Select-Object -First 1
          $ver = if ($line) { $line.Matches.Groups[1].Value } else { "1.0.0" }
          "version=$ver" >> $env:GITHUB_OUTPUT

      - name: Build PyInstaller binary
        working-directory: server
        shell: pwsh
        run: |
          .\.venv\Scripts\Activate.ps1
          pyinstaller `
            --onedir `
            --name tallysync-server `
            --distpath ..\dist\bin `
            --workpath $env:TEMP\tallysync-build `
            --noconfirm `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=anyio._backends._asyncio `
            --hidden-import=anyio._backends._trio `
            --hidden-import=sqlalchemy.dialects.sqlite `
            --collect-all=sse_starlette `
            --collect-all=apscheduler `
            main.py

      - name: Assemble distribution package
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $PKG = "dist\TallySync-v$VERSION-Windows"

          if (Test-Path $PKG) { Remove-Item -Recurse -Force $PKG }
          New-Item -ItemType Directory -Path "$PKG\server-bin\data" -Force | Out-Null
          New-Item -ItemType Directory -Path "$PKG\setup"            -Force | Out-Null

          Copy-Item -Recurse "dist\bin\tallysync-server\*"    "$PKG\server-bin\"
          Copy-Item -Recurse "pages"                          "$PKG\pages"
          Copy-Item -Recurse "assets"                         "$PKG\assets"

          # Copy setup scripts
          Copy-Item "setup\start-binary.bat"                  "$PKG\setup\start.bat"
          if (Test-Path "setup\install-autostart-windows.bat") {
            Copy-Item "setup\install-autostart-windows.bat"   "$PKG\setup\"
          }

          # Write README using an array (avoids here-string YAML issues)
          @(
            "TallySync Manager - Windows Quick Start",
            "=========================================",
            "",
            "1. Double-click: setup\start.bat",
            "   The server starts and your browser opens automatically.",
            "",
            "2. To auto-start at Windows login (run once):",
            "   Double-click: setup\install-autostart-windows.bat",
            "   (Run as Administrator if prompted)",
            "",
            "Requirements: Windows 10+ (no Python required)",
            "Version: $VERSION"
          ) | Set-Content "$PKG\README.txt" -Encoding utf8

          # Zip the package
          Compress-Archive -Path $PKG -DestinationPath "dist\TallySync-v$VERSION-Windows.zip" -Force
          Write-Host "Created: dist\TallySync-v$VERSION-Windows.zip"

      - name: Upload artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: TallySync-Windows
          path: dist/TallySync-v*-Windows.zip
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/TallySync-v*-Windows.zip

  # ── macOS Build ──────────────────────────────────────────────────────────────
  build-macos:
    name: macOS binary (PyInstaller)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies + PyInstaller
        working-directory: server
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt --quiet
          pip install pyinstaller --quiet

      - name: Get version from config
        id: version
        run: |
          VER=$(grep -oP 'APP_VERSION\s*=\s*"\K[^"]+' server/config.py || echo "1.0.0")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build PyInstaller binary
        working-directory: server
        run: |
          source .venv/bin/activate
          pyinstaller \
            --onedir \
            --name tallysync-server \
            --distpath ../dist/bin \
            --workpath /tmp/tallysync-build \
            --noconfirm \
            --hidden-import=uvicorn.logging \
            --hidden-import=uvicorn.loops \
            --hidden-import=uvicorn.loops.auto \
            --hidden-import=uvicorn.protocols \
            --hidden-import=uvicorn.protocols.http \
            --hidden-import=uvicorn.protocols.http.auto \
            --hidden-import=uvicorn.protocols.websockets \
            --hidden-import=uvicorn.protocols.websockets.auto \
            --hidden-import=uvicorn.lifespan \
            --hidden-import=uvicorn.lifespan.on \
            --hidden-import=anyio._backends._asyncio \
            --hidden-import=anyio._backends._trio \
            --hidden-import=sqlalchemy.dialects.sqlite \
            --collect-all=sse_starlette \
            --collect-all=apscheduler \
            main.py

      - name: Assemble distribution package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PKG="dist/TallySync-v${VERSION}-macOS"

          rm -rf "$PKG"
          mkdir -p "$PKG/server-bin/data"
          mkdir -p "$PKG/setup"

          cp -r dist/bin/tallysync-server/. "$PKG/server-bin/"
          chmod +x "$PKG/server-bin/tallysync-server"
          cp -r pages  "$PKG/"
          cp -r assets "$PKG/"

          # Copy setup scripts (start.sh auto-detects binary vs venv)
          [ -f "setup/start.sh" ]                    && cp "setup/start.sh" "$PKG/setup/" && chmod +x "$PKG/setup/start.sh"
          [ -f "setup/install-autostart-macos.sh" ]  && cp "setup/install-autostart-macos.sh" "$PKG/setup/"
          [ -f "setup/com.tallysync.manager.plist" ] && cp "setup/com.tallysync.manager.plist" "$PKG/setup/"
          [ -d "TallySync.app" ]                     && cp -r "TallySync.app" "$PKG/"

          # Write README using printf (avoids heredoc YAML indentation issues)
          printf '%s\n' \
            "TallySync Manager - macOS Quick Start" \
            "======================================" \
            "" \
            "Option A - Double-click launcher (easiest):" \
            "  Open TallySync.app" \
            "" \
            "Option B - Terminal:" \
            "  chmod +x setup/start.sh && ./setup/start.sh" \
            "" \
            "Option C - Auto-start at login:" \
            "  ./setup/install-autostart-macos.sh" \
            "" \
            "Requirements: macOS 12+ (no Python required)" \
            "Version: $VERSION" > "$PKG/README.txt"

          cd dist
          zip -r "TallySync-v${VERSION}-macOS.zip" "TallySync-v${VERSION}-macOS" -x "*.DS_Store"
          echo "Created: dist/TallySync-v${VERSION}-macOS.zip"

      - name: Upload artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: TallySync-macOS
          path: dist/TallySync-v*-macOS.zip
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/TallySync-v*-macOS.zip
